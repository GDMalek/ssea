<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Star English Academy Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center py-6 mb-8 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-indigo-700">
                ⭐ Super Star English Academy ⭐
            </h1>
            <p class="text-gray-500 mt-2">Student Score and Progress Tracker</p>
        </header>

        <!-- Loading Indicator and Error Message -->
        <div id="status-message" class="text-center p-4 rounded-lg text-lg hidden" role="status"></div>

        <!-- Main Content Grid -->
        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">

            <!-- Col 1: Student Actions (Registration, Check-in, Logging) -->
            <div id="student-actions" class="lg:col-span-1 space-y-6">

                <!-- Student Profile Card -->
                <div id="profile-card" class="bg-white p-6 rounded-xl card hidden">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 12a12 12 0 10-24 0h24z" />
                        </svg>
                        My Profile
                    </h2>
                    <p class="text-lg mb-2">
                        <span class="font-medium text-gray-700">Student ID:</span> 
                        <span id="display-student-id" class="text-sm bg-gray-100 p-1 rounded font-mono"></span>
                    </p>
                    <p class="text-xl mb-4 font-bold text-gray-800">
                        <span id="display-roll-class"></span>
                    </p>
                    
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                         <!-- Daily Check-in -->
                        <button id="check-in-btn" class="w-full sm:w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition duration-150 ease-in-out shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Daily Check-in
                        </button>

                        <!-- Log Score Modal Trigger -->
                        <button id="show-score-modal-btn" class="w-full sm:w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition duration-150 ease-in-out shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                              <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                            </svg>
                            Log Score
                        </button>
                    </div>
                </div>

                <!-- Registration Card -->
                <div id="registration-card" class="bg-white p-6 rounded-xl card">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Register Student</h2>
                    <form id="registration-form" class="space-y-4">
                        <div>
                            <label for="roll-no" class="block text-sm font-medium text-gray-700 mb-1">Roll Number</label>
                            <input type="text" id="roll-no" required placeholder="e.g., S001" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="class-name" class="block text-sm font-medium text-gray-700 mb-1">Class Name</label>
                            <input type="text" id="class-name" required placeholder="e.g., 9-A" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                            Register & Sign In
                        </button>
                    </form>
                </div>
            </div>

            <!-- Col 2 & 3: Real-time Leaderboard -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl card">
                <h2 class="text-2xl font-semibold text-pink-600 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.659c-.204-.254-.535-.254-.739 0l-1.84 2.296-3.894.417-2.31 2.457c-.15.16-.234.373-.234.593v10.388c0 .22.084.433.234.593l2.31 2.457 3.894.417 1.84 2.296c.204.254.535.254.739 0l1.84-2.296 3.894-.417 2.31-2.457c.15-.16.234-.373.234-.593V5.574c0-.22-.084-.433-.234-.593l-2.31-2.457-3.894-.417-1.84-2.296z" />
                    </svg>
                    Scoreboard (Top Students)
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <th class="py-3 px-4">Rank</th>
                                <th class="py-3 px-4">Roll No. / Class</th>
                                <th class="py-3 px-4 text-right">Total Score</th>
                                <th class="py-3 px-4 text-center">Streak (Days)</th>
                                <th class="py-3 px-4 text-center">Last Check-in</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200">
                            <!-- Leaderboard data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div> <!-- End Main Content Grid -->
    </div> <!-- End app container -->

    <!-- Score Logging Modal -->
    <div id="score-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-xl font-bold mb-4 text-indigo-700">Log Daily Score</h3>
            <form id="score-form" class="space-y-4">
                <div>
                    <label for="daily-score" class="block text-sm font-medium text-gray-700 mb-1">Score Achieved (0-100)</label>
                    <input type="number" id="daily-score" required min="0" max="100" placeholder="e.g., 95" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-modal-btn" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">Submit Score</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- JavaScript Logic -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            collection, 
            query, 
            orderBy, // We will sort client-side, but keep it available if needed for filtering
            where,
            runTransaction,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAspAFZvTLXtg6yzxRGZYmrNoNm2tr1T7g",
  authDomain: "superstaracademy.firebaseapp.com",
  projectId: "superstaracademy",
  storageBucket: "superstaracademy.firebasestorage.app",
  messagingSenderId: "1084907814138",
  appId: "1:1084907814138:web:512b9a68de6acd99389d43",
  measurementId: "G-R06VBGG0VL"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        // Set Firebase Log Level to Debug for development visibility
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (provided by environment or manually set) ---
        // The __app_id is used in the Firestore path.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'superstar-english-academy';
        
        // --- FIREBASE CONFIGURATION ---
        // CRITICAL FIX: Prioritize Canvas-provided config (__firebase_config) 
        // over the hardcoded placeholder to ensure authentication works.
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAspAFZvTLXtg6yzxRGZYmrNoNm2tr1T7g",
            authDomain: "superstaracademy.firebaseapp.com",
            projectId: "superstaracademy",
            storageBucket: "superstaracademy.firebasestorage.app",
            messagingSenderId: "1084907814138",
            appId: "1:1084907814138:web:512b9a68de6acd99389d43",
            measurementId: "G-R06VBGG0VL"
        };
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            // Use config provided by the Canvas environment
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // Use the manual config (e.g., if running outside Canvas)
            firebaseConfig = MANUAL_FIREBASE_CONFIG;
        }

        // The provided authentication token from the environment
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- APP INITIALIZATION ---
        let app, db, auth;
        let currentUserId = null;
        let currentStudentData = null; // Store current logged-in student's data
        let isAuthReady = false;

        const statusMessageEl = document.getElementById('status-message');
        const mainContentEl = document.getElementById('main-content');
        const registrationCardEl = document.getElementById('registration-card');
        const profileCardEl = document.getElementById('profile-card');
        const registrationForm = document.getElementById('registration-form');
        const checkInBtn = document.getElementById('check-in-btn');
        const showScoreModalBtn = document.getElementById('show-score-modal-btn');
        const scoreModal = document.getElementById('score-modal');
        const scoreForm = document.getElementById('score-form');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // Utility to display status messages
        function showStatus(message, isError = false) {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (isError) {
                statusMessageEl.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusMessageEl.classList.add('bg-blue-100', 'text-blue-700');
            }
            setTimeout(() => {
                statusMessageEl.classList.add('hidden');
            }, 5000);
        }

        // Helper function to get the current date key (YYYY-MM-DD)
        function getDateKey(date = new Date()) {
            return date.toISOString().split('T')[0];
        }
        
        // Helper function to calculate the time difference in days
        function daysBetween(date1, date2) {
            const ONE_DAY = 1000 * 60 * 60 * 24;
            const diffTime = Math.abs(date2 - date1);
            return Math.ceil(diffTime / ONE_DAY);
        }


        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                showStatus("Connecting to Firebase...");
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // CRITICAL FIX: Use the initialAuthToken if provided, otherwise sign in anonymously.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    showStatus("Signed in with custom token.", false);
                } else {
                    // Fallback to anonymous sign-in if no token is available
                    await signInAnonymously(auth); 
                    showStatus("Signed in anonymously.", false);
                }

                currentUserId = auth.currentUser.uid;
                
                isAuthReady = true;
                mainContentEl.classList.remove('hidden');
                showStatus("Connection successful. Ready.", false);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showStatus("Error connecting to Firebase. Check console for details (auth/configuration-not-found often means wrong config is used).", true);
            }
        }

        // --- DATA PATH UTILITIES ---
        function getStudentCollectionRef() {
            // Public path for the student leaderboard data
            return collection(db, `artifacts/${appId}/public/data/students`);
        }

        function getStudentDocRef(studentId) {
            return doc(getStudentCollectionRef(), studentId);
        }

        // --- CORE APPLICATION LOGIC ---

        // 1. Student Registration
        function createStudentId(rollNo, className) {
            // Create a consistent, unique ID based on input data
            return `${className.trim().toUpperCase()}-${rollNo.trim().toUpperCase()}`;
        }

        async function registerStudent(rollNo, className) {
            const studentId = createStudentId(rollNo, className);
            const studentDocRef = getStudentDocRef(studentId);

            try {
                const docSnap = await getDoc(studentDocRef);

                if (docSnap.exists()) {
                    showStatus("Student already registered. Signing in...", false);
                    currentStudentData = docSnap.data();
                } else {
                    const today = getDateKey();
                    const newStudentData = {
                        studentId: studentId,
                        rollNo: rollNo.trim().toUpperCase(),
                        className: className.trim().toUpperCase(),
                        totalScore: 0,
                        streak: 0,
                        lastCheckIn: null, // No check-in yet
                        registrationDate: today,
                        lastScoreLog: null,
                    };
                    
                    await setDoc(studentDocRef, newStudentData);
                    currentStudentData = newStudentData;
                    showStatus("Registration successful! Welcome.", false);
                }
                
                // Once data is retrieved or created, update UI
                updateProfileUI(currentStudentData);
                
            } catch (error) {
                console.error("Registration/Sign-in failed:", error);
                showStatus("Failed to register or sign in. Check security rules and console.", true);
            }
        }

        // 2. Daily Check-in Logic
        async function handleCheckIn() {
            if (!currentStudentData) {
                showStatus("Please register or sign in first.", true);
                return;
            }

            const todayKey = getDateKey();
            const lastCheckIn = currentStudentData.lastCheckIn;
            const studentDocRef = getStudentDocRef(currentStudentData.studentId);
            
            // Check if already checked in today
            if (lastCheckIn === todayKey) {
                showStatus("You have already checked in today!", false);
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(studentDocRef);
                    if (!docSnap.exists()) {
                        throw "Student document does not exist!";
                    }
                    
                    const existingData = docSnap.data();
                    let newStreak = existingData.streak;
                    let message = "Check-in recorded!";

                    if (existingData.lastCheckIn) {
                        const lastDate = new Date(existingData.lastCheckIn);
                        const todayDate = new Date();
                        const daysDiff = daysBetween(lastDate, todayDate);

                        if (daysDiff === 1) {
                            // Check-in continuation
                            newStreak += 1;
                            message = `Daily Check-in successful! Streak is now ${newStreak} days!`;
                        } else if (daysDiff > 1) {
                            // Streak broken
                            newStreak = 1;
                            message = "Welcome back! Your streak was reset. Streak is now 1 day.";
                        } 
                        // If daysDiff is 0, handled above (already checked in)
                    } else {
                        // First-ever check-in
                        newStreak = 1;
                        message = "First check-in recorded! Start your streak!";
                    }

                    const newCheckInData = {
                        ...existingData,
                        lastCheckIn: todayKey,
                        streak: newStreak
                    };

                    transaction.set(studentDocRef, newCheckInData);
                    currentStudentData = newCheckInData; // Update local state
                    showStatus(message, false);
                });
            } catch (error) {
                console.error("Check-in transaction failed:", error);
                showStatus("Check-in failed. Please try again.", true);
            }
        }

        // 3. Log Score Logic
        async function handleLogScore(score) {
            if (!currentStudentData) {
                showStatus("Please register or sign in first.", true);
                return;
            }

            const todayKey = getDateKey();
            const studentDocRef = getStudentDocRef(currentStudentData.studentId);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(studentDocRef);
                    if (!docSnap.exists()) {
                        throw "Student document does not exist!";
                    }

                    const existingData = docSnap.data();
                    const scoreInt = parseInt(score, 10);

                    if (isNaN(scoreInt) || scoreInt < 0 || scoreInt > 100) {
                        throw "Invalid score input.";
                    }
                    
                    const newTotalScore = existingData.totalScore + scoreInt;

                    const newScoreLogData = {
                        ...existingData,
                        totalScore: newTotalScore,
                        lastScoreLog: todayKey,
                    };

                    transaction.set(studentDocRef, newScoreLogData);
                    currentStudentData = newScoreLogData; // Update local state
                    showStatus(`Score of ${scoreInt} logged successfully. Total score: ${newTotalScore}`, false);
                    document.getElementById('daily-score').value = ''; // Clear input
                });
            } catch (error) {
                console.error("Score logging transaction failed:", error);
                showStatus(error.message || "Score logging failed. Please check input and try again.", true);
            }
        }


        // 4. Leaderboard Listener
        function setupLeaderboardListener() {
            if (!db || !isAuthReady) return;

            // Note: Firebase `orderBy` is often limited. We fetch all and sort client-side.
            const q = query(getStudentCollectionRef());

            onSnapshot(q, (snapshot) => {
                const students = [];
                snapshot.forEach((doc) => {
                    students.push(doc.data());
                });

                // Client-side sorting: highest score first
                students.sort((a, b) => b.totalScore - a.totalScore);
                
                renderLeaderboard(students);
            }, (error) => {
                console.error("Error reading leaderboard:", error);
                showStatus("Could not fetch leaderboard data.", true);
            });
        }
        
        // --- UI RENDERING ---

        function updateProfileUI(studentData) {
            if (studentData) {
                document.getElementById('display-student-id').textContent = studentData.studentId;
                document.getElementById('display-roll-class').textContent = `Roll No: ${studentData.rollNo}, Class: ${studentData.className}`;

                registrationCardEl.classList.add('hidden');
                profileCardEl.classList.remove('hidden');
            } else {
                registrationCardEl.classList.remove('hidden');
                profileCardEl.classList.add('hidden');
            }
        }

        function renderLeaderboard(students) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = ''; // Clear existing rows

            students.forEach((student, index) => {
                const rank = index + 1;
                let rankClass = 'text-gray-900';
                
                if (rank === 1) rankClass = 'text-yellow-600 font-extrabold';
                else if (rank === 2) rankClass = 'text-gray-500 font-bold';
                else if (rank === 3) rankClass = 'text-amber-700 font-semibold';


                const row = `
                    <tr class="hover:bg-indigo-50/50 transition duration-100 ${rank % 2 !== 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="py-4 px-4 whitespace-nowrap text-sm ${rankClass}">${rank}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-700 font-medium">${student.rollNo} / ${student.className}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-sm text-right font-extrabold text-indigo-800">${student.totalScore}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-sm text-center font-bold text-green-600">${student.streak}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-xs text-center text-gray-400">${student.lastCheckIn || 'N/A'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // --- EVENT LISTENERS ---

        // 1. Registration Submission
        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const rollNo = document.getElementById('roll-no').value;
            const className = document.getElementById('class-name').value;
            if (rollNo && className) {
                registerStudent(rollNo, className);
            }
        });

        // 2. Check-in Button
        checkInBtn.addEventListener('click', handleCheckIn);
        
        // 3. Score Modal Toggles
        showScoreModalBtn.addEventListener('click', () => {
            scoreModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', () => {
            scoreModal.classList.add('hidden');
        });
        
        // 4. Score Submission
        scoreForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const dailyScore = document.getElementById('daily-score').value;
            if (dailyScore) {
                handleLogScore(dailyScore);
                scoreModal.classList.add('hidden');
            }
        });

        // --- RUN APP ---
        window.onload = () => {
            initializeFirebase();
            
            // Set up a listener for the current user's data once auth is ready.
            // This also kicks off the leaderboard listener.
            const authCheckInterval = setInterval(() => {
                if (isAuthReady) {
                    clearInterval(authCheckInterval);
                    // The leaderboard is public, so start listening immediately
                    setupLeaderboardListener();
                }
            }, 500);
        };

    </script>

</body>
</html>
